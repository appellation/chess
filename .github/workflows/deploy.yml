name: Deploy

on:
  release:
    types:
      - created
  workflow_dispatch:

jobs:
  digitalocean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          known_hosts: ${{ secrets.DIGITALOCEAN_KNOWN_HOSTS }}

      - name: Set environment
        run: >
          DATABASE_URL=$(doctl db get e66951fa-2a87-4022-a526-e2a57a556417 --output json | jq .[0].private_connection.uri -r)

          echo "rm -f .env &&
          touch .env &&
          echo \"DATABASE_URL=$DATABASE_URL\" >> .env &&
          echo \"DISCORD_TOKEN=$DISCORD_TOKEN\" >> .env" | doctl compute ssh 215874001
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}

      - name: Deploy
        run: |
          echo "if [ ! -d "./chess" ]; then
            git clone https://appellation:${GH_TOKEN}@github.com/appellation/chess.git
            cd chess
          else
            cd chess
            git fetch origin
            git reset --hard origin/master
          fi

          mv -f ../.env .

          chmod +x ./run.sh
          ./run.sh prod pull
          ./run.sh prod build
          ./run.sh prod up -d" | doctl compute ssh 215874001
